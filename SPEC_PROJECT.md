{"bgColorIndex":0,"note":"# SPEC_PROJECT — Assistant Trading XAUUSD\nMac-first (DEV Docker) + VPS Windows MT5 (PROD performance)\nVersion: V1 + V1.1 (IA Copilote) + V2 (IA Coach)\n\n---\n\n## 0) Objectif\nConstruire un assistant de trading pour XAUUSD qui :\n- analyse à la **clôture M15**\n- utilise **H1** comme contexte (bias \/ régime)\n- envoie des signaux dans un **groupe Telegram** (pas d’app utilisateur)\n- log toutes les décisions (GO\/NO_GO) + raisons + features dans **SQLite**\n- applique une gestion du risque :\n  - **1% par défaut**\n  - **2% seulement si signal A+ (score ≥ 90)**\n- gère **2 TP** (simple + pro) :\n  - TP1: prendre 50% puis SL = entrée (break-even)\n  - TP2: prendre le reste\n- est conçu pour un déploiement prod **sans refonte** :\n  - même API \/ mêmes modules \/ mêmes messages\n  - seule la source de données change (Mock → MT5)\n\n⚠️ V1 : aucun auto-trade. Alertes + gestion uniquement.\n⚠️ Aucun système ne garantit des gains.\n\n---\n\n## 1) Produit = Telegram (pas d’app)\n- Le “produit” = un groupe Telegram qui reçoit les signaux.\n- Le système ne spam pas :\n  - Telegram reçoit GO + événements importants seulement\n  - toutes les analyses sont loggées en base (même NO_GO)\n\n---\n\n## 2) Environnements (IMPORTANT)\n### 2.1 DEV Mac — obligatoire\n- Tout tourne sur Mac via Docker Compose :\n  - API FastAPI\n  - n8n (optionnel, V1 peut envoyer Telegram directement)\n  - SQLite (volume)\n- Data DEV : MockDataProvider (CSV)\n\n### 2.2 PROD Windows VPS — performance\n- MT5 tourne nativement sur Windows (data broker + specs exactes)\n- Python tourne sur la même machine (latence minimale)\n- Data PROD : MT5DataProvider\n\n### 2.3 Règle “zéro refonte”\n- le cœur (règles\/agents\/API\/DB\/messages) est identique DEV\/PROD\n- switch uniquement par env :\n  - DATA_PROVIDER=mock en DEV\n  - DATA_PROVIDER=mt5 en PROD\n\n---\n\n## 3) Instrument \/ TF\n- Symbol: XAUUSD\n- Signal TF: M15\n- Contexte TF: H1\n- Option V2: M5 en affinage (pas V1)\n\n---\n\n## 4) Fenêtres de trading (Europe\/Paris)\n- Session 1: 14:30–18:30\n- Session 2 (option): 20:00–22:00\nHors fenêtre => NO_GO (OUT_OF_SESSION)\n\n---\n\n## 5) Hard rules (bloquantes)\nSi une hard rule échoue => NO_GO + blocked_by\n1) OUT_OF_SESSION\n2) NEWS_LOCK : high impact news ±30 min\n3) SPREAD_TOO_HIGH : spread > seuil\n4) VOLATILITY_TOO_HIGH : ATR\/volatilité > seuil\n5) RR_TOO_LOW : RR(TP2) >= 2.0 obligatoire\n6) DAILY_BUDGET_REACHED : perte jour >= budget\n7) DUPLICATE_SIGNAL : cooldown \/ signal_key\n8) DATA_OFF : provider down\/latence excessive\n9) EXECUTION_GUARD : prix trop loin de l’entrée (late entry \/ slippage)\n\n---\n\n## 6) Contexte H1 (bias \/ régime)\n- Régime: UP \/ DOWN \/ RANGE\nRègles:\n- UP => BUY only\n- DOWN => SELL only\n- RANGE => neutre mais score plus strict\n\nSi setup contre bias (hors RANGE) => NO_GO (NO_TREND_BIAS)\n\n---\n\n## 7) Setups V1 (4 setups)\n1) Breakout + Retest\n2) Rejet sur niveau (S\/R)\n3) Pullback tendance (continuation)\n4) Range propre (support\/résistance si H1=RANGE)\nAucun setup => NO_GO (NO_SETUP)\n\n---\n\n## 8) TP\/SL — 2 TP (OFFICIEL)\n- TP1: prendre 50% puis SL = entrée (Break-even)\n- TP2: prendre le reste\n\nPratique MT5:\n- ouvrir 2 positions (50% \/ 50%)\n- même SL au départ\n- position A: TP1, position B: TP2\n- quand TP1 touché => SL(B)=entrée\n\n---\n\n## 9) Score \/100 (sélection)\nObjectif: 4–5 opportunités max\/jour mais filtrées.\n\nScore exemple (configurable):\n- Bias H1 aligné +25\n- Setup clair +25\n- RR(TP2) >= 2.0 +20\n- Spread OK +10\n- Volatilité OK +10\n- News OK +10\nTotal 100\n\nSeuils:\n- GO si score >= 80\n- A+ si score >= 90\n\n---\n\n## 10) Risk management (OFFICIEL)\n- Standard: 1% du capital\n- A+ (score>=90): 2% du capital (option activable)\n- Budget perte max\/jour: 2% (configurable)\n- 1 position max simultanée (V1)\n- cooldown 15–30 min (config)\n\nFormules:\n- Risque(€) = Capital × risk_percent\n- Budget jour(€) = Capital × daily_budget_percent\n\nLot (principe):\n- Lot ≈ Risque \/ (Distance_SL × Valeur_du_point)\n- DEV: valeur du point en config\n- PROD: lire tick_value\/tick_size via MT5 (symbol specs)\n\nOption:\n- LOT_MAX_USER (ex 0.03) => lot = min(lot_calculé, lot_max)\n- si lot_min_broker > lot calculé => warning ou NO_GO\n\n---\n\n## 11) IA — V1.1 (copilote décisionnel)\nBut: l’IA aide à décider et expliquer, mais ne peut pas contourner les hard rules.\n\n### 11.1 Dossier de décision (input IA)\nLes agents déterministes produisent un JSON \"DecisionPacket\" factuel:\n- session_ok (bool)\n- news_lock (bool + next_event)\n- spread (float) + spread_max\n- atr (float) + atr_max\n- candles (résumé) + niveaux clés\n- bias_h1 (UP\/DOWN\/RANGE)\n- setups_detected (liste)\n- proposed_entry\/sl\/tp1\/tp2 + RR\n- score_rules (0-100)\n- reasons_rules (liste)\n- state (daily_budget_used, consecutive_losses, cooldown_ok)\n- timestamps + latence\n\n### 11.2 Output IA (strict)\nIA renvoie JSON strict:\n- decision: GO|NO_GO\n- confidence: 0-100\n- quality: A+|A|B\n- why: [max 3 phrases]\n- notes: (court) (option)\nTimeout IA: 2s. Si timeout => fallback règles seules.\n\n### 11.3 Safety gates\n- Si hard rule KO => décision finale NO_GO (même si IA dit GO)\n- IA n’a pas le droit de modifier entry\/sl\/tp si hard rules KO\n\n---\n\n## 12) IA — V2 (coach batch)\nChaque jour:\n- analyse des signaux vs outcomes (trades)\n- calcule stats: winrate, expectancy, drawdown\n- détecte patterns: stop hunt, news, regimes\n- propose ajustements (seuils\/filters)\nRésultats stockés en DB (table `coach_reports` option).\n\n---\n\n## 13) Telegram (anti-spam)\nTelegram envoie:\n- GO toujours\n- important seulement: DATA_OFF, NEWS_LOCK pause, (option) bias change\n\nFormat GO:\nGO ✅ XAUUSD (M15)\n\nDirection : {BUY\/SELL}\nEntrée : {entry}\nStop Loss : {sl}\nTP1 : {tp1} → Prendre 50% + Mettre SL = Entrée\nTP2 : {tp2} → Prendre le reste\n\nPourquoi : {raison1} + {raison2} + {raison3}\nScore : {score}\/100 — Qualité : {A+\/A}\n\n⚠️ Risque :\n- Standard: 1% du capital\n- A+ (score ≥ 90): 2% du capital\nRisque (€) = Capital × {1% ou 2%}\nLot ≈ Risque \/ (Distance_SL × Valeur_du_point)\nExemples risque (1%): 500€→5€ | 1000€→10€ | 2000€→20€\n\nFormat NO_GO important:\nNO GO ❌ XAUUSD (M15)\nRaison : {blocked_by} — {phrase courte}\nProchaine vérif : {heure\/condition}\n\n---\n\n## 14) Base SQLite (obligatoire)\n### 14.1 Table `signals`\n- id\n- ts_utc\n- symbol\n- tf_signal, tf_context\n- status GO\/NO_GO\n- blocked_by\n- direction\n- entry, sl, tp1, tp2\n- rr_tp2\n- score_total\n- score_rules_json\n- ai_enabled (bool)\n- ai_output_json (nullable)\n- decision_packet_json\n- signal_key\n- reasons_json\n- message\n- data_latency_ms\n- ai_latency_ms\n\n### 14.2 Table `trades` (V2 sync MT5)\n- id\n- signal_id\n- opened_at, closed_at\n- exit_type SL\/TP1\/TP2\/BE\/MANUAL\n- pnl\n- r_multiple\n- volume\n- fees\n\n### 14.3 Table `state`\n- day_paris\n- daily_loss_amount\n- daily_budget_amount\n- consecutive_losses\n- mode NORMAL\/CONSERVATIVE\n- last_signal_key, last_ts\n\n### blocked_by enum\nOUT_OF_SESSION\nNEWS_LOCK\nSPREAD_TOO_HIGH\nVOLATILITY_TOO_HIGH\nMARKET_CHOP\nNO_TREND_BIAS\nNO_SETUP\nRR_TOO_LOW\nDUPLICATE_SIGNAL\nDAILY_BUDGET_REACHED\nDATA_OFF\nEXECUTION_GUARD\n\n---\n\n## 15) API (FastAPI)\n- GET \/health\n- POST \/analyze\n  - construit DecisionPacket (agents déterministes)\n  - applique hard rules + score\n  - (V1.1) appelle IA si enabled + timeout\n  - décision finale (safety gates)\n  - construit message Telegram\n  - écrit en DB `signals`\n  - renvoie JSON Decision + message\n- POST \/trade\/sync (V2)\n- GET \/stats\/summary (V2)\n\n---\n\n## 16) Providers (interface)\nInterface DataProvider :\n- get_candles(symbol, timeframe, n)\n- get_spread(symbol)\n- get_symbol_specs(symbol) (tick_value, tick_size, lot_min, lot_step, etc.)\n- get_server_time()\n- (V2) get_trade_history()\n\nDEV: MockDataProvider (CSV)\nPROD: MT5DataProvider (Windows MT5 natif)\n\n---\n\n## 17) n8n (option)\nV1 peut envoyer Telegram depuis l’API directement.\nSi n8n utilisé:\n1) Cron\n2) POST \/analyze\n3) IF go => Telegram\n4) IF important no_go => Telegram\n\n---\n\n## 18) Déploiement (objectif: simple)\nDEV Mac:\n- docker compose up --build\n\nPROD Windows VPS:\n- même repo + mêmes endpoints\n- config env:\n  - DATA_PROVIDER=mt5\n  - TELEGRAM config\n- MT5 installé et connecté au broker\n- service Python tourne en continu\n- option: docker\/n8n selon choix\n\n---\n\n## 19) Roadmap\nSprint 1:\n- repo + docker-compose (api + sqlite + n8n option)\n- schema sqlite + migrations simples\n- \/health + \/analyze mock + formatter Telegram + logs\n- tests minimal\n\nSprint 2:\n- règles hard + score + setups V1\n- anti-duplicate + daily budget + state\n- backtest CSV + tests\n\nSprint 3:\n- IA V1.1 (DecisionPacket + output strict + timeout fallback)\n- logs latence + DATA_OFF\n\nSprint 4:\n- PROD VPS Windows + MT5DataProvider + forward test\n- trade sync V2 (trades table)\n\nSprint 5:\n- IA coach batch V2","textColorIndex":1}